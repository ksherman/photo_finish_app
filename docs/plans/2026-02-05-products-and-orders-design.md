# Products & Orders Design

## Overview

Add product catalog management and order capture to PhotoFinish. The vertical slice is **USB-only ordering at kiosks** — customers browse photos, select the USB package for their gymnast(s), enter contact info, and receive an order number. Staff handles payment and fulfillment offline.

## Scope

### In Scope (Vertical Slice)
- Default product catalog with per-event price overrides
- Order capture at kiosks (USB package only)
- Multi-competitor orders (e.g., parent with 2 daughters = 2 line items)
- Staff admin view to manage orders (mark paid, mark fulfilled)
- Order number generation

### Designed But Deferred
- Print products (data model supports them, no UI yet)
- Collage / customized photo products
- Multi-competitor discount / bundle pricing
- Payment integration (Square, Stripe, etc.)
- Online ordering (hosted for post-event purchases)
- Shipping / fulfillment workflows
- USB drive file preparation automation

## Data Model

### ProductTemplate (system-level catalog)

Master product list. Not event-scoped — reusable across all events.

| Field | Type | Notes |
|-------|------|-------|
| id | uuid | PK |
| product_type | enum | `:usb`, `:print`, `:collage`, `:custom_photo`, `:accessory` |
| product_name | string | Display name, e.g. "All Photos USB Drive" |
| product_size | string | Nullable. e.g. "5x7", "8x10". Null for USB/accessories |
| default_price_cents | integer | Default price in cents |
| is_active | boolean | Can be soft-disabled from future events |
| display_order | integer | Controls ordering on forms/UI |

### EventProduct (per-event pricing)

When an event is created, active product templates are copied into event-scoped rows with price overrides.

| Field | Type | Notes |
|-------|------|-------|
| id | uuid | PK |
| event_id | fk → events | |
| product_template_id | fk → product_templates | |
| price_cents | integer | Actual price for this event (initialized from default) |
| is_available | boolean | Can disable specific products per event |

### Order

One per customer transaction.

| Field | Type | Notes |
|-------|------|-------|
| id | uuid | PK |
| event_id | fk → events | |
| order_number | string | Generated: `{event.order_code}-{NNNN}` |
| customer_name | string | Required |
| customer_email | string | Nullable |
| customer_phone | string | Nullable |
| subtotal_cents | integer | Sum of line items |
| tax_rate_basis_points | integer | Snapshot from event at order time |
| tax_cents | integer | Calculated |
| total_cents | integer | subtotal + tax |
| payment_status | enum | `:pending`, `:paid`, `:refunded` |
| payment_reference | string | Nullable — for Square/payment reconciliation |
| notes | text | Nullable — staff notes |

### OrderItem

Each line item. For USB vertical slice, typically 1 item per competitor.

| Field | Type | Notes |
|-------|------|-------|
| id | uuid | PK |
| order_id | fk → orders | |
| event_product_id | fk → event_products | Links to event-specific product + price |
| event_competitor_id | fk → event_competitors | Which gymnast this is for |
| quantity | integer | Default 1 |
| unit_price_cents | integer | Snapshot of price at time of order |
| line_total_cents | integer | quantity * unit_price |
| fulfillment_status | enum | `:pending`, `:fulfilled` |

### Events table addition

Add `next_order_number` integer (default 0) to events for sequence generation. May switch to nanoid later if race conditions become a concern.

## Order Number Generation

Format: `{event.order_code}-{NNNN}` (zero-padded 4 digits, e.g., "STV-0042").

Generated by atomically incrementing `events.next_order_number` within the order creation transaction. The order_number field is a plain string, so the generation strategy can be swapped to nanoid later without schema changes.

## Kiosk Order Flow

### Step 1: Identify Gymnast
Customer is already browsing photos by competitor in the viewer. An "Order Photos" button appears on the competitor's gallery.

### Step 2: Review & Select Products
Screen shows the USB package with price and the gymnast's name/photo count. Customer can add additional competitors (e.g., a sibling) as separate line items. Confirms selection.

### Step 3: Contact Info & Submit
Customer enters name (required), email and phone (optional). Submits the order. Screen displays the order number prominently (e.g., "Your order number is STV-0042"). Kiosk resets to viewer.

## Staff Admin Flow

An admin view lists orders for the current event:
- Order number, customer name, gymnast(s), total, payment/fulfillment status
- Mark as paid + enter payment reference
- Add notes
- Mark individual items as fulfilled

No batch processing or complex fulfillment queues for the vertical slice.

## Design Decisions

1. **ProductTemplate + EventProduct split** — Avoids re-entering the same products for every event. Default catalog with per-event price overrides. Most events only need to change the USB price.

2. **Price snapshots on order items** — `unit_price_cents` is copied at order time so price changes don't retroactively affect existing orders.

3. **Tax snapshot on orders** — `tax_rate_basis_points` copied from event at order time for the same reason.

4. **event_competitor_id on order items (not orders)** — Supports multi-competitor orders naturally. One parent, two gymnasts = one order, two line items.

5. **Fulfillment on items, payment on orders** — Payment is per-transaction, but fulfillment is per-item (each USB is prepared separately).

6. **No shipping for vertical slice** — All orders are on-site pickup.
